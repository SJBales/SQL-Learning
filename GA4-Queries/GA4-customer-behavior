-- Task Overview

-- Find users that:
-- 1. Had multiple sessions in a single day
-- 2. Viewed products but didn't purchase in their first session
-- 3. Returned within 6 hours and completed a purchase

--------------------------------------------------------------

-- Prepping an initial backbone table with key columns
WITH backbone AS (SELECT user_pseudo_id,
       event_name,
       TIMESTAMP_MICROS(event_timestamp) AS event_timestamp,
       DATE(TIMESTAMP_MICROS(event_timestamp)) AS event_date,
       (SELECT events.value.int_value FROM UNNEST(event_params) AS events WHERE events.key = 'ga_session_id') AS session_id,
       CASE
        WHEN event_name = 'view_item' THEN 1 ELSE NULL END AS viewed_item,
       CASE
        WHEN event_name = 'purchase' THEN 1 ELSE NULL END AS purchased
FROM `bigquery-public-data.ga4_obfuscated_sample_ecommerce.events_*`
ORDER BY user_pseudo_id, session_id, event_timestamp),

-- Creating a table using aggregating to start analyses
analysis_table AS (SELECT user_pseudo_id,
       session_id,
       event_date,
       CASE WHEN SUM(viewed_item) > 0 THEN 1 ELSE 0 END AS viewed_item,
       CASE WHEN SUM(purchased) > 0 THEN 1 ELSE 0 END AS purchased_in_session,
       MIN(event_timestamp) AS start_timestamp,
       MAX(event_timestamp) AS end_timestamp,
       -- Window to get the total intraday sessions
       COUNT(DISTINCT session_id)
        OVER(PARTITION BY user_pseudo_id, 
                          event_date) AS total_intraday_sessions,
       -- Window to get the intraday session number
       ROW_NUMBER()
        OVER(PARTITION BY user_pseudo_id,
                          event_date
             ORDER BY MIN(event_timestamp)) AS intraday_session_number
FROM backbone
GROUP BY user_pseudo_id,
         session_id,
         event_date),

-- Adding additional columns to filter off of
filtering_table AS (
       SELECT *,
       -- Window to get hours since last sesion
       EXTRACT(HOUR FROM end_timestamp - LAG(start_timestamp,1)
        OVER(PARTITION BY user_pseudo_id
             ORDER BY start_timestamp)) AS time_since_last_session,
       -- Window to get if the customer ever purchased
       MAX(CASE WHEN purchased_in_session > 0 THEN 1 ELSE 0 END)
        OVER(PARTITION BY user_pseudo_id) AS ever_purchased
       -- NEXT SESSION: add CASE-WHEN to get customers who viewed items but did not purchase on the first visit
FROM analysis_table
ORDER BY user_pseudo_id, intraday_session_number)

SELECT *
FROM filtering_table
WHERE ever_purchased > 0;
