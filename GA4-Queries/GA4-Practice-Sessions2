--For each user, calculate their session number (chronological order)
--For each session, calculate:

--Time spent (in minutes)
--Days since their previous session
--Their average time spent in previous 3 sessions (excluding current)
--Their percentile rank for engagement time among all sessions that day


--Identify users whose average session time is increasing over time (compare first 3 sessions to last 3 sessions)

---------------------------------------------------------------

-- CTE to calculate session order, start date and end date
WITH session_backbone AS (
  SELECT user_pseudo_id,
         (SELECT events.value.int_value
          FROM UNNEST(event_params) AS events
          WHERE events.key = 'ga_session_number') AS session_number,
          MIN(event_timestamp) AS session_start,
          MAX(event_timestamp) AS session_end
  FROM `bigquery-public-data.ga4_obfuscated_sample_ecommerce.events_*`
  GROUP BY user_pseudo_id, 
           session_number
  ORDER BY user_pseudo_id, session_number
),

-- Chained CTE to calculate session duration and time since last session
session_data AS (
  SELECT user_pseudo_id,
         session_number,
         DATE(TIMESTAMP_MICROS(session_start)) as session_date,
       ROUND((session_end - session_start) / (1000000 * 60), 2) AS session_duration_minutes,
       ROUND((session_start - LAG(session_end, 1) 
        OVER(PARTITION BY user_pseudo_id
             ORDER BY session_number)) / (1000000 * 60 * 60 * 24), 2) AS days_since_last_session
FROM session_backbone)

-- Testing CTE's
SELECT *
FROM session_data;
