--Write a query that:

-- 1. Identifies distinct sessions for each user (use 30-minute inactivity timeout)
-- 2. Calculates session metrics: pages viewed, time spent, conversion events
-- 3. Uses self-join to find users who had multiple "high-quality" sessions (≥5 pages AND ≥300 seconds)
-- 4. Uses window functions to rank sessions by quality within each user
-- 5. Compares multi-session power users vs single-session users

-- Creating a raw table for session metrics
WITH raw_table AS (
  SELECT user_pseudo_id,
       TIMESTAMP_MICROS(event_timestamp) AS event_timestamp,
       event_name,
       (SELECT events.value.int_value
        FROM UNNEST(event_params) events 
        WHERE events.key = 'ga_session_id') AS session_id,
       (SELECT events.value.string_value
        FROM UNNEST(event_params) events
        WHERE events.key = 'page_title') AS page_viewed
FROM `bigquery-public-data.ga4_obfuscated_sample_ecommerce.events_20210131`
ORDER BY user_pseudo_id, event_timestamp),

-- Getting the timing of sessions
session_timing AS (SELECT user_pseudo_id,
       session_id,
       MIN(event_timestamp)
        OVER(PARTITION BY user_pseudo_id,
                          session_id) AS session_start,
      MAX(event_timestamp)
       OVER(PARTITION BY user_pseudo_id,
                         session_id) AS session_end
FROM raw_table)

SELECT *
FROM raw_table;
