-- Find the distribution of total active days by users


------------------- Query -------------------

-- Initial query to get total sessions by user
WITH sessions AS (
  SELECT user_pseudo_id,
         DATE(TIMESTAMP_MICROS(event_timestamp)) AS event_date,
         COUNT(*) AS total_events
  FROM `bigquery-public-data.ga4_obfuscated_sample_ecommerce.events_*`
  WHERE event_name NOT IN ('session_start', 'view_promotion')
        --AND _TABLE_SUFFIX IN ('20210126', '20210127', '20210128', '20210129', '20210130', '20210131')
  GROUP BY user_pseudo_id,
           DATE(TIMESTAMP_MICROS(event_timestamp))),

-- Getting total active days by user
total_active_days AS (
      SELECT user_pseudo_id,
      COUNT(*) AS total_sessions
FROM sessions
GROUP BY user_pseudo_id),

-- Finding the percentile rank of total daily sessions
perc_rank AS (SELECT *,
       ROUND(PERCENT_RANK() OVER(ORDER BY total_sessions), 2) AS session_percent_rank
FROM total_active_days)

-- Final query to find the answer
SELECT *
FROM perc_rank
WHERE session_percent_rank >= 0.9
ORDER BY total_sessions DESC;
