--For each user, calculate their session number (chronological order)
--For each session, calculate:

--Time spent (in minutes)
--Days since their previous session
--Their average time spent in previous 3 sessions (excluding current)
--Their percentile rank for engagement time among all sessions that day


--Identify users whose average session time is increasing over time (compare first 3 sessions to last 3 sessions)

---------------------------------------------------------------

-- CTE to calculate session order, start date and end date
WITH session_backbone AS (
  SELECT user_pseudo_id,
         (SELECT events.value.int_value
          FROM UNNEST(event_params) AS events
          WHERE events.key = 'ga_session_id') AS session_id,
          MIN(event_timestamp) AS session_start,
          MAX(event_timestamp) AS session_end
  FROM `bigquery-public-data.ga4_obfuscated_sample_ecommerce.events_*`
  GROUP BY user_pseudo_id, 
           session_id
  ORDER BY user_pseudo_id, session_id
),

-- Chained CTE to calculate session duration and time since last session
session_data AS (
  SELECT user_pseudo_id,
         session_id,
         TIMESTAMP_MICROS(session_start) AS session_start,
         DATE(TIMESTAMP_MICROS(session_start)) as session_date,
         ROW_NUMBER() 
           OVER(PARTITION BY user_pseudo_id
                ORDER BY session_start) AS session_number,
         ROUND((session_end - session_start) / (1000000 * 60), 2) AS session_duration_minutes,
         ROUND((session_start - LAG(session_start, 1) 
         OVER(PARTITION BY user_pseudo_id
              ORDER BY session_start)) / (1000000 * 60 * 60 * 24), 2) AS days_since_last_session
FROM session_backbone)

-- Getting average time spent in last three sessions and percentile rank
SELECT *,
       ROUND(AVG(session_duration_minutes)
         OVER(PARTITION BY user_pseudo_id
              ORDER BY session_number
              ROWS BETWEEN 3 PRECEDING AND 1 PRECEDING), 2) AS last_three_sesion_duration,
        PERCENT_RANK()
         OVER(PARTITION BY user_pseudo_id,
              session_date
              ORDER BY session_duration_minutes) AS session_rank
FROM session_data
ORDER BY user_pseudo_id, session_number, session_date;
